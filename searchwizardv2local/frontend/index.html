<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SearchWizard V2 Local - Simple Document Generator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2563eb;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #1f2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            border-color: #2563eb;
            background: #f8fafc;
        }
        
        .upload-area.dragover {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        textarea {
            height: 120px;
            resize: vertical;
        }
        
        button {
            background: #2563eb;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        button:hover { background: #1d4ed8; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .template-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .template-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .template-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .template-card:hover .delete-btn {
            display: flex;
        }
        
        .template-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .template-type {
            color: #666;
            font-size: 0.9em;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .status.success {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .document-preview {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            background: #f9fafb;
        }
        
        .kb-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .kb-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        .kb-tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #666;
            font-weight: 500;
        }
        
        .kb-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        
        .kb-tab-content {
            display: none;
        }
        
        .kb-tab-content.active {
            display: block;
        }
        
        .kb-form {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .kb-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .kb-items {
            display: grid;
            gap: 10px;
        }
        
        .kb-item {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .kb-item-info {
            flex: 1;
        }
        
        .kb-item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .kb-item-meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .kb-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            background: #6b7280;
        }
        
        .btn-small:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SearchWizard V2 Local</h1>
            <p class="subtitle">Simple AI Document Generator - Upload template, enter requirements, generate document</p>
        </header>
        
        <!-- Knowledge Base Section -->
        <div class="kb-section">
            <h2>📚 Knowledge Base</h2>
            <p style="color: #666; margin-bottom: 20px;">Store company information, logos, and documents for automatic inclusion in generated documents</p>
            
            <div class="kb-tabs">
                <div class="kb-tab active" onclick="switchKBTab('company')">Company Profile</div>
                <div class="kb-tab" onclick="switchKBTab('files')">Files & Images</div>
                <div class="kb-tab" onclick="switchKBTab('text')">Text Snippets</div>
                <div class="kb-tab" onclick="switchKBTab('browse')">Browse All</div>
            </div>
            
            <!-- Company Profile Tab -->
            <div id="kb-company" class="kb-tab-content active">
                <div class="kb-form">
                    <input type="text" id="company-name" placeholder="Company Name" />
                    <div class="form-row">
                        <input type="text" id="company-address" placeholder="Address" />
                        <input type="text" id="company-phone" placeholder="Phone" />
                    </div>
                    <div class="form-row">
                        <input type="email" id="company-email" placeholder="Email" />
                        <input type="url" id="company-website" placeholder="Website" />
                    </div>
                    <textarea id="company-description" placeholder="Company Description"></textarea>
                    <button onclick="saveCompanyProfile()">Save Company Profile</button>
                </div>
                <div id="company-status" class="status"></div>
            </div>
            
            <!-- Files Tab -->
            <div id="kb-files" class="kb-tab-content">
                <div class="kb-form">
                    <div class="upload-area" id="kb-upload-area">
                        <p>📁 Upload files (logos, images, documents)</p>
                        <p style="margin: 10px 0; color: #666;">Drag & drop or click to select</p>
                        <input type="file" id="kb-file-input" accept="image/*,.pdf,.doc,.docx,.txt" style="display: none;">
                    </div>
                    <input type="text" id="kb-file-name" placeholder="Display name for this file" />
                    <div class="form-row">
                        <select id="kb-file-category">
                            <option value="logos">Logos</option>
                            <option value="images">Images</option>
                            <option value="documents">Documents</option>
                            <option value="templates">Templates</option>
                        </select>
                        <input type="text" id="kb-file-description" placeholder="Description (optional)" />
                    </div>
                    <button id="upload-kb-file" onclick="uploadKBFile()" disabled>Upload File</button>
                </div>
                <div id="kb-files-status" class="status"></div>
            </div>
            
            <!-- Text Tab -->
            <div id="kb-text" class="kb-tab-content">
                <div class="kb-form">
                    <input type="text" id="kb-text-name" placeholder="Name (e.g., 'Standard Terms', 'Contact Info')" />
                    <div class="form-row">
                        <select id="kb-text-type">
                            <option value="text">General Text</option>
                            <option value="contact">Contact Information</option>
                            <option value="terms">Terms & Conditions</option>
                            <option value="description">Description</option>
                        </select>
                        <select id="kb-text-category">
                            <option value="company">Company</option>
                            <option value="legal">Legal</option>
                            <option value="contact">Contact</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <textarea id="kb-text-content" placeholder="Enter the text content..." rows="4"></textarea>
                    <button onclick="addKBText()">Add Text Snippet</button>
                </div>
                <div id="kb-text-status" class="status"></div>
            </div>
            
            <!-- Browse Tab -->
            <div id="kb-browse" class="kb-tab-content">
                <div id="kb-items-list" class="kb-items">
                    <!-- Knowledge base items will be loaded here -->
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Upload Template Section -->
            <div class="section">
                <h2>1. Create Template</h2>
                
                <div id="upload-status" class="status"></div>
                
                <div class="upload-area" id="upload-area">
                    <p>📄 Drag & drop a document here</p>
                    <p style="margin: 10px 0; color: #666;">or click to select</p>
                    <p style="font-size: 0.9em; color: #999;">Supports PDF and text files</p>
                    <input type="file" id="file-input" accept=".pdf,.txt,.doc,.docx" style="display: none;">
                </div>
                
                <input type="text" id="template-name" placeholder="Template name (e.g., 'Job Description')" />
                
                <button id="create-template" disabled>
                    <span id="create-loading" class="loading" style="display: none;"></span>
                    Create Template
                </button>
                
                <div id="templates-list">
                    <h3 style="margin-top: 25px; margin-bottom: 15px;">Available Templates</h3>
                    <div id="template-grid" class="template-grid">
                        <!-- Templates will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Generate Document Section -->
            <div class="section">
                <h2>2. Generate Document</h2>
                
                <div id="generate-status" class="status"></div>
                
                <div id="template-selection">
                    <p style="margin-bottom: 15px; color: #666;">Select a template first</p>
                </div>
                
                <textarea id="requirements" placeholder="Enter your requirements for the new document...&#10;&#10;Example:&#10;- Company: TechCorp Inc.&#10;- Position: Senior Software Engineer&#10;- Location: Remote&#10;- Requirements: 5+ years Python, React experience"></textarea>
                
                <button id="generate-document" disabled>
                    <span id="generate-loading" class="loading" style="display: none;"></span>
                    Generate Document
                </button>
                
                <button id="generate-pdf" disabled style="margin-left: 10px; background: #059669;">
                    <span id="pdf-loading" class="loading" style="display: none;"></span>
                    Generate PDF
                </button>
            </div>
        </div>
        
        <!-- Generated Document Preview -->
        <div class="section full-width" id="document-section" style="display: none;">
            <h2>3. Generated Document</h2>
            <div style="margin-bottom: 15px;">
                <button id="download-html">Download HTML</button>
                <button id="copy-content" style="margin-left: 10px;">Copy Content</button>
                <button id="download-pdf" style="margin-left: 10px; background: #059669;">Download PDF</button>
            </div>
            <div id="document-preview" class="document-preview"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let selectedTemplate = null;
        let currentDocument = null;

        // Upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const templateNameInput = document.getElementById('template-name');
        const createTemplateBtn = document.getElementById('create-template');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelection();
            }
        });

        fileInput.addEventListener('change', handleFileSelection);

        function handleFileSelection() {
            const file = fileInput.files[0];
            if (file) {
                uploadArea.innerHTML = `<p>📄 Selected: ${file.name}</p>`;
                if (!templateNameInput.value) {
                    templateNameInput.value = file.name.replace(/\.[^/.]+$/, "");
                }
                updateCreateButton();
            }
        }

        templateNameInput.addEventListener('input', updateCreateButton);

        function updateCreateButton() {
            createTemplateBtn.disabled = !fileInput.files[0] || !templateNameInput.value.trim();
        }

        createTemplateBtn.addEventListener('click', async () => {
            const file = fileInput.files[0];
            const name = templateNameInput.value.trim();
            
            if (!file || !name) return;

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);

            showStatus('upload-status', 'Creating template...', 'info');
            showLoading('create-loading', true);
            createTemplateBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/templates`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('upload-status', `Template "${result.name}" created successfully!`, 'success');
                    loadTemplates();
                    // Reset form
                    fileInput.value = '';
                    templateNameInput.value = '';
                    uploadArea.innerHTML = `
                        <p>📄 Drag & drop a document here</p>
                        <p style="margin: 10px 0; color: #666;">or click to select</p>
                        <p style="font-size: 0.9em; color: #999;">Supports PDF and text files</p>
                    `;
                } else {
                    showStatus('upload-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('upload-status', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('create-loading', false);
                createTemplateBtn.disabled = false;
            }
        });

        // Generate document handling
        const requirementsInput = document.getElementById('requirements');
        const generateBtn = document.getElementById('generate-document');
        const generatePdfBtn = document.getElementById('generate-pdf');

        generateBtn.addEventListener('click', async () => {
            if (!selectedTemplate || !requirementsInput.value.trim()) return;

            const requestData = {
                template_id: selectedTemplate.id,
                requirements: requirementsInput.value.trim()
            };

            showStatus('generate-status', 'Generating document...', 'info');
            showLoading('generate-loading', true);
            generateBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('generate-status', 'Document generated successfully!', 'success');
                    currentDocument = result;
                    showDocument(result.content);
                } else {
                    showStatus('generate-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('generate-status', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('generate-loading', false);
                generateBtn.disabled = false;
            }
        });

        // Generate PDF directly
        generatePdfBtn.addEventListener('click', async () => {
            if (!selectedTemplate || !requirementsInput.value.trim()) return;

            const requestData = {
                template_id: selectedTemplate.id,
                requirements: requirementsInput.value.trim()
            };

            showStatus('generate-status', 'Generating PDF document...', 'info');
            showLoading('pdf-loading', true);
            generatePdfBtn.disabled = true;

            try {
                const response = await fetch(`${API_BASE}/generate-pdf`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${selectedTemplate.name}_${Date.now()}.pdf`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showStatus('generate-status', 'PDF generated and downloaded!', 'success');
                } else {
                    const result = await response.json();
                    showStatus('generate-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('generate-status', `Error: ${error.message}`, 'error');
            } finally {
                showLoading('pdf-loading', false);
                generatePdfBtn.disabled = false;
            }
        });

        // Download and copy handlers
        document.getElementById('download-html').addEventListener('click', () => {
            if (currentDocument) {
                const blob = new Blob([currentDocument.content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `document_${Date.now()}.html`;
                a.click();
                URL.revokeObjectURL(url);
            }
        });

        document.getElementById('copy-content').addEventListener('click', () => {
            if (currentDocument) {
                navigator.clipboard.writeText(currentDocument.content);
                showStatus('generate-status', 'Content copied to clipboard!', 'success');
            }
        });

        document.getElementById('download-pdf').addEventListener('click', async () => {
            if (currentDocument) {
                try {
                    const response = await fetch(`${API_BASE}/documents/${currentDocument.document_id}/pdf`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `document_${currentDocument.document_id}.pdf`;
                        a.click();
                        URL.revokeObjectURL(url);
                        showStatus('generate-status', 'PDF downloaded!', 'success');
                    } else {
                        showStatus('generate-status', 'Error generating PDF', 'error');
                    }
                } catch (error) {
                    showStatus('generate-status', `Error: ${error.message}`, 'error');
                }
            }
        });

        // Utility functions
        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function showLoading(elementId, show) {
            document.getElementById(elementId).style.display = show ? 'inline-block' : 'none';
        }

        function showDocument(content) {
            const documentSection = document.getElementById('document-section');
            const documentPreview = document.getElementById('document-preview');
            
            // Create an iframe to safely display HTML
            const iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = 'none';
            
            documentPreview.innerHTML = '';
            documentPreview.appendChild(iframe);
            
            iframe.contentDocument.open();
            iframe.contentDocument.write(content);
            iframe.contentDocument.close();
            
            documentSection.style.display = 'block';
            documentSection.scrollIntoView({ behavior: 'smooth' });
        }

        async function loadTemplates() {
            try {
                const response = await fetch(`${API_BASE}/templates`);
                const result = await response.json();
                
                const templateGrid = document.getElementById('template-grid');
                templateGrid.innerHTML = '';
                
                if (result.templates && result.templates.length > 0) {
                    result.templates.forEach(template => {
                        const card = document.createElement('div');
                        card.className = 'template-card';
                        card.innerHTML = `
                            <button class="delete-btn" onclick="deleteTemplate('${template.id}', event)" title="Delete template">×</button>
                            <div class="template-name">${template.name}</div>
                            <div class="template-type">${template.document_type}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">
                                Used ${template.usage_count || 0} times
                            </div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            // Don't select if delete button was clicked
                            if (e.target.classList.contains('delete-btn')) return;
                            
                            // Remove selection from other cards
                            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
                            card.classList.add('selected');
                            
                            selectedTemplate = template;
                            updateGenerateSection();
                        });
                        
                        templateGrid.appendChild(card);
                    });
                } else {
                    templateGrid.innerHTML = '<p style="color: #666; text-align: center; grid-column: 1 / -1;">No templates yet. Create one above!</p>';
                }
            } catch (error) {
                console.error('Failed to load templates:', error);
            }
        }

        function updateGenerateSection() {
            const selectionDiv = document.getElementById('template-selection');
            if (selectedTemplate) {
                selectionDiv.innerHTML = `
                    <div style="background: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <strong>Selected Template:</strong> ${selectedTemplate.name}<br>
                        <span style="color: #666;">Type: ${selectedTemplate.document_type}</span>
                    </div>
                `;
                updateGenerateButtons();
                requirementsInput.addEventListener('input', updateGenerateButtons);
            }
        }

        function updateGenerateButtons() {
            const hasRequirements = requirementsInput.value.trim();
            generateBtn.disabled = !hasRequirements;
            generatePdfBtn.disabled = !hasRequirements;
        }

        // Template deletion function
        async function deleteTemplate(templateId, event) {
            event.stopPropagation(); // Prevent card selection
            
            // Find template name for confirmation
            const templates = await fetch(`${API_BASE}/templates`).then(r => r.json());
            const template = templates.templates.find(t => t.id === templateId);
            const templateName = template ? template.name : 'this template';
            
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete "${templateName}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showStatus('upload-status', result.message, 'success');
                    
                    // Clear selection if this template was selected
                    if (selectedTemplate && selectedTemplate.id === templateId) {
                        selectedTemplate = null;
                        document.getElementById('template-selection').innerHTML = '<p style="color: #666;">Select a template first</p>';
                        updateGenerateButtons();
                    }
                    
                    // Reload templates
                    loadTemplates();
                } else {
                    const error = await response.json();
                    showStatus('upload-status', `Error deleting template: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('upload-status', `Error deleting template: ${error.message}`, 'error');
            }
        }

        // Knowledge Base Functions
        function switchKBTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.kb-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.kb-tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(`kb-${tabName}`).classList.add('active');
            
            // Load knowledge base items if browsing
            if (tabName === 'browse') {
                loadKnowledgeBase();
            }
        }

        // Knowledge base file upload handling
        const kbUploadArea = document.getElementById('kb-upload-area');
        const kbFileInput = document.getElementById('kb-file-input');
        const kbFileNameInput = document.getElementById('kb-file-name');

        kbUploadArea.addEventListener('click', () => kbFileInput.click());
        kbUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            kbUploadArea.classList.add('dragover');
        });
        kbUploadArea.addEventListener('dragleave', () => {
            kbUploadArea.classList.remove('dragover');
        });
        kbUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            kbUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                kbFileInput.files = files;
                handleKBFileSelection();
            }
        });

        kbFileInput.addEventListener('change', handleKBFileSelection);

        function handleKBFileSelection() {
            const file = kbFileInput.files[0];
            if (file) {
                kbUploadArea.innerHTML = `<p>📁 Selected: ${file.name}</p>`;
                if (!kbFileNameInput.value) {
                    kbFileNameInput.value = file.name.replace(/\.[^/.]+$/, "");
                }
                document.getElementById('upload-kb-file').disabled = false;
            }
        }

        async function saveCompanyProfile() {
            const profile = {
                company_name: document.getElementById('company-name').value.trim(),
                address: document.getElementById('company-address').value.trim(),
                phone: document.getElementById('company-phone').value.trim(),
                email: document.getElementById('company-email').value.trim(),
                website: document.getElementById('company-website').value.trim(),
                description: document.getElementById('company-description').value.trim()
            };

            if (!profile.company_name) {
                showStatus('company-status', 'Company name is required', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/knowledge-base/company-profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(profile)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('company-status', 'Company profile saved successfully!', 'success');
                } else {
                    showStatus('company-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('company-status', `Error: ${error.message}`, 'error');
            }
        }

        async function uploadKBFile() {
            const file = kbFileInput.files[0];
            const name = document.getElementById('kb-file-name').value.trim();
            const category = document.getElementById('kb-file-category').value;
            const description = document.getElementById('kb-file-description').value.trim();

            if (!file || !name) {
                showStatus('kb-files-status', 'File and name are required', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', name);
            formData.append('category', category);
            formData.append('description', description);

            try {
                const response = await fetch(`${API_BASE}/knowledge-base/upload`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('kb-files-status', `File "${name}" uploaded successfully!`, 'success');
                    // Reset form
                    kbFileInput.value = '';
                    document.getElementById('kb-file-name').value = '';
                    document.getElementById('kb-file-description').value = '';
                    kbUploadArea.innerHTML = `
                        <p>📁 Upload files (logos, images, documents)</p>
                        <p style="margin: 10px 0; color: #666;">Drag & drop or click to select</p>
                    `;
                    document.getElementById('upload-kb-file').disabled = true;
                } else {
                    showStatus('kb-files-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('kb-files-status', `Error: ${error.message}`, 'error');
            }
        }

        async function addKBText() {
            const item = {
                name: document.getElementById('kb-text-name').value.trim(),
                content: document.getElementById('kb-text-content').value.trim(),
                type: document.getElementById('kb-text-type').value,
                category: document.getElementById('kb-text-category').value
            };

            if (!item.name || !item.content) {
                showStatus('kb-text-status', 'Name and content are required', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/knowledge-base/text`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('kb-text-status', `Text snippet "${item.name}" added successfully!`, 'success');
                    // Reset form
                    document.getElementById('kb-text-name').value = '';
                    document.getElementById('kb-text-content').value = '';
                } else {
                    showStatus('kb-text-status', `Error: ${result.detail}`, 'error');
                }
            } catch (error) {
                showStatus('kb-text-status', `Error: ${error.message}`, 'error');
            }
        }

        async function loadKnowledgeBase() {
            try {
                const response = await fetch(`${API_BASE}/knowledge-base`);
                const result = await response.json();
                
                const itemsList = document.getElementById('kb-items-list');
                itemsList.innerHTML = '';
                
                if (result.knowledge_base && result.knowledge_base.length > 0) {
                    result.knowledge_base.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'kb-item';
                        
                        const typeIcon = item.type === 'image' ? '🖼️' : 
                                       item.type === 'company_profile' ? '🏢' : 
                                       item.type === 'document' ? '📄' : '📝';
                        
                        itemDiv.innerHTML = `
                            <div class="kb-item-info">
                                <div class="kb-item-name">${typeIcon} ${item.name}</div>
                                <div class="kb-item-meta">
                                    Type: ${item.type} | Category: ${item.category || 'general'}
                                    ${item.file_size ? ` | Size: ${(item.file_size / 1024).toFixed(1)}KB` : ''}
                                </div>
                            </div>
                            <div class="kb-item-actions">
                                ${item.type === 'image' ? `<button class="btn-small" onclick="viewKBFile('${item.stored_filename}')">View</button>` : ''}
                                <button class="btn-small btn-danger" onclick="deleteKBItem('${item.id}')">Delete</button>
                            </div>
                        `;
                        
                        itemsList.appendChild(itemDiv);
                    });
                } else {
                    itemsList.innerHTML = '<p style="color: #666; text-align: center;">No knowledge base items yet. Add some using the tabs above!</p>';
                }
            } catch (error) {
                console.error('Failed to load knowledge base:', error);
            }
        }

        async function deleteKBItem(itemId) {
            if (!confirm('Are you sure you want to delete this knowledge base item?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/knowledge-base/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadKnowledgeBase(); // Reload the list
                    showStatus('company-status', 'Knowledge base item deleted successfully!', 'success');
                } else {
                    const error = await response.json();
                    showStatus('company-status', `Error: ${error.detail}`, 'error');
                }
            } catch (error) {
                showStatus('company-status', `Error: ${error.message}`, 'error');
            }
        }

        function viewKBFile(filename) {
            window.open(`${API_BASE}/knowledge-base/files/${filename}`, '_blank');
        }

        // Initialize
        loadTemplates();
        loadKnowledgeBase();
    </script>
</body>
</html>